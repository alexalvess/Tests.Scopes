version: "3.9"
services:
  db:
    image: "mcr.microsoft.com/mssql/server"
    environment:
      SA_PASSWORD: "!MyStrongPassword"
      ACCEPT_EULA: "Y"
    ports:
      - "1433"
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "$$SA_PASSWORD" -Q "SELECT 1" || exit 1
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - internal

  api:
    image: api:latest
    build:
      context: .
      dockerfile: ./Test.Scopes/Dockerfile
    depends_on:
      db:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Staging
    ports:
      - "80"
    healthcheck:
      test: curl --silent --fail http://localhost:80/health || exit 1
      interval: 5s
      timeout: 10s
      retries: 3
    networks:
      - internal

  web:
    image: web:latest
    build:
      context: .
      dockerfile: ./Test.Scopes.App/Dockerfile
    depends_on:
      - api
    environment:
      ASPNETCORE_ENVIRONMENT: Staging
    ports:
      - "5000"
    networks:
      - internal

  e2e:
    image: cypress
    build: ./Test.Scopes.E2E
    container_name: cypress
    depends_on:
      - web
      - api
      - db
    command: npx cypress run
    volumes:
      - ./Test.Scopes.E2E/cypress:/app/cypress
      - ./Test.Scopes.E2E/cypress.json:/app/cypress.json
    networks:
      - internal

networks:
  internal:
    name: internal
    driver: bridge